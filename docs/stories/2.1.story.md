# Story 2.1: Document Source Connector

## Status
Ready for Review

## Story
**As a** system,
**I want** to clone a specified public Git repository containing Markdown documents,
**so that** I can access the raw content for processing.

## Acceptance Criteria
1. An API endpoint (e.g., POST /api/ingest) exists to trigger the process.
2. The service successfully clones the repository specified in an environment variable to a temporary location.
3. The service can list all .md files within the cloned repository.

## Tasks / Subtasks
- [x] Task 1: Create the /api/ingest endpoint (AC: 1)
  - [x] Create ingest directory structure at `apps/web/app/api/ingest/`
  - [x] Implement POST route handler following Next.js 14 app directory patterns
  - [x] Add TypeScript interfaces for request/response bodies
  - [x] Follow API specification from architecture docs
- [x] Task 2: Implement Git repository cloning functionality (AC: 2)
  - [x] Add git cloning dependency (isomorphic-git or simple-git)
  - [x] Create repository cloning service function
  - [x] Handle repository URL from environment variable
  - [x] Clone to temporary directory with proper cleanup
  - [x] Add error handling for invalid repositories or network failures
- [x] Task 3: Implement Markdown file discovery (AC: 3)
  - [x] Create file system scanning function for .md files
  - [x] Recursively search cloned repository directory
  - [x] Return list of discovered markdown file paths
  - [x] Handle empty repositories or no markdown files found
- [x] Task 4: Add comprehensive testing (Testing Standards)
  - [x] Create unit tests for ingest endpoint API route
  - [x] Mock git cloning functionality for tests
  - [x] Test successful repository cloning and file discovery
  - [x] Test error scenarios (invalid repo, network failures, no .md files)
  - [x] Test environment variable configuration

## Dev Notes

### Previous Story Insights
From Story 1.3: Health endpoint successfully implemented using Next.js 14 app directory patterns with comprehensive TypeScript support and testing framework established.

### API Specifications
[Source: architecture/5-api-specification.md]
- **POST /api/ingest**
  - **Purpose**: Triggers the document ingestion pipeline
  - **Request Body**: { "repositoryUrl": "string" }
  - **Response**: { "message": "Ingestion started.", "documentCount": number }

### Tech Stack Requirements
[Source: architecture/3-tech-stack.md]
- **Backend Language**: TypeScript 5.x for type safety for API logic
- **API Style**: REST / RPC via Next.js API Routes - Simple, well-understood, native to Next.js
- **Frontend Framework**: Next.js 14.x with React for UI framework and serverless backend

### Data Models
[Source: architecture/4-data-models.md]
- **DocumentChunk Interface**: Stores processed text chunks with vector embeddings
  ```typescript
  interface DocumentChunk {
    id: string; // UUID
    source_document: string;
    content: string;
    embedding: number[]; // Vector embedding
    created_at: string; // Timestamp
  }
  ```

### Project Structure Requirements
[Source: architecture/6-unified-project-structure-monorepo.md]
- Ingest endpoint location: `apps/web/app/api/ingest/route.ts`
- API Routes located at: `apps/web/app/api/` with route.ts files
- Shared library code location: `apps/web/app/(lib)/` for database and utility functions

### Development Workflow Requirements
[Source: architecture/7-development-workflow.md]
- Development server: `npm run dev` starts Next.js development server
- Local development requires Node.js v20+
- Environment variables managed through `.env.local` file

### Testing Requirements
[Source: architecture/8-testing-strategy.md]
- **Backend Tests**: Unit tests for API route handlers, mocking database and LLM clients
- Test files should be placed in `apps/web/__tests__/` directory
- Use Jest 29.x for unit and integration testing for API routes

### Technical Constraints
- Must use TypeScript 5.x with strict type safety for API endpoints
- Follow Next.js 14 app directory patterns for API routes (not pages directory)
- Environment variable for repository URL must be configurable
- Implement proper error handling for git operations and file system access
- Use temporary directories for cloning with proper cleanup to avoid storage issues
- Handle various repository formats and structures gracefully

### Git Integration Requirements
- Select appropriate git library (isomorphic-git for browser compatibility or simple-git for Node.js)
- Support public repositories (authentication not required for MVP)
- Clone repositories to temporary locations with unique identifiers
- Implement cleanup mechanisms for temporary cloned repositories
- Handle git operation failures gracefully with meaningful error messages

### File Discovery Implementation
- Recursive directory scanning for .md files
- Support nested directory structures within repositories
- Return relative file paths from repository root
- Handle various markdown file extensions (.md, .markdown)
- Provide file count in API response as specified

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-04 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.1 (claude-opus-4-1-20250805)

### Debug Log References
(To be populated by dev agent)

### Completion Notes List
- Successfully implemented POST /api/ingest endpoint following Next.js 14 app directory patterns
- Implemented git repository cloning with simple-git library and proper cleanup mechanisms
- Created comprehensive file scanning service for markdown file discovery
- Added extensive unit testing for all service layers with proper mocking
- All TypeScript compilation passes without errors
- Build process completes successfully with all routes properly registered

### File List
- apps/web/app/api/ingest/route.ts (new)
- apps/web/app/(lib)/git-service.ts (new) 
- apps/web/app/(lib)/file-service.ts (new)
- apps/web/__tests__/api-ingest.test.ts (new)
- apps/web/__tests__/git-service.test.ts (new)
- apps/web/__tests__/file-service.test.ts (new)
- apps/web/jest.setup.js (modified)
- apps/web/package.json (modified)

## QA Results
(To be populated by QA agent)